<!DOCTYPE html><html lang="vi"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flashcard Tiếng Trung</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #1a202c;
      color: white;
      font-family: sans-serif;
      margin: 0;
    }.card {
  background-color: #4a5568;
  transition: transform 0.3s ease, background-color 0.3s ease;
}

.card.swiping {
  background-color: #bfdbfe !important; /* blue-200 */
}

  </style>
</head><body class="min-h-screen flex items-center justify-center">
  <div id="app" class="w-full max-w-md p-4 text-center">Đang tải dữ liệu...</div><button onclick="renderHome()"
class="fixed bottom-4 right-4 bg-gray-500 text-white px-4 py-2 rounded shadow hover:bg-gray-600"> Quay lại </button>

  <script>
    let app = document.getElementById("app");
    let fullData = [];
    let sessions = [];
    let progress = {};
    let selected = new Set();
    let seen = new Set(); // NEW

    const local = {
      save: (k, d) => localStorage.setItem(k, JSON.stringify(d)),
      load: (k) => JSON.parse(localStorage.getItem(k) || "null")
    };

    function addSwipeHandler(cardEl, onRight, onLeft) {
      let startX = 0, currentX = 0;
      cardEl.addEventListener("touchstart", e => startX = e.touches[0].clientX);
      cardEl.addEventListener("touchmove", e => {
        currentX = e.touches[0].clientX - startX;
        cardEl.classList.add("swiping");
        cardEl.style.transform = `translateX(${currentX}px) rotate(${currentX / 15}deg)`;
      });
      cardEl.addEventListener("touchend", () => {
        cardEl.classList.remove("swiping");
        if (currentX > 80) setTimeout(onRight, 150);
        else if (currentX < -80) setTimeout(onLeft, 150);
        else cardEl.style.transform = "translateX(0) rotate(0)";
        startX = 0; currentX = 0;
      });
    }

    function renderFlashcards(words, mode = "learn", sessionIndex = null) {
      let i = 0;
      const originalLength = words.length;
      const completed = new Set();
      function render() {
        while (i < words.length && completed.has(words[i].traditional)) i++;

        if (i >= words.length) {
          if (mode === "learn" && sessionIndex !== null) {
            progress[sessionIndex + 1] = sessions[sessionIndex];
            local.save("progress", progress);
          }
          app.innerHTML = `<div class="text-center"><h2 class="text-xl font-bold text-green-400">✅ Hoàn thành!</h2></div>`;
          return;
        }

        const w = words[i];
        const learnedCount = completed.size;
        const percent = Math.round((learnedCount / originalLength) * 100);
        const showMeaning = mode === "learn";
        const pinyinLine = `<div class='text-xl mt-3 text-gray-300'>${w.pinyin}</div>`;
        const meaningLine = `<div class='text-lg mt-1'>${w.meaning}</div>`;

        app.innerHTML = `
          <div class="w-full space-y-4">
            <div class="w-full bg-gray-700 h-2 rounded">
              <div class="bg-blue-400 h-2 rounded" style="width:${Math.min(percent, 100)}%"></div>
            </div>
            <div id="flashcard" class="card text-white rounded-2xl shadow-lg flex flex-col items-center justify-center text-center select-none mx-auto" style="height:80vh;">
              <div class="text-6xl font-bold">${w.traditional}</div>
              ${showMeaning ? `${pinyinLine}${meaningLine}` : `<div id='revealBtn' class='text-gray-300 mt-4 underline'>Chạm để hiện</div>`}
              <div class="text-sm mt-4 text-gray-200 italic">Vuốt phải để đánh dấu đã thuộc, vuốt trái nếu chưa thuộc</div>
            </div>
            <p class="text-center text-sm text-gray-400">${learnedCount}/${originalLength} từ đã thuộc</p>
          </div>`;

        const cardEl = document.getElementById("flashcard");
        if (!showMeaning) {
          cardEl.addEventListener("click", () => {
            cardEl.innerHTML = `
              <div class="text-6xl font-bold">${w.traditional}</div>
              ${pinyinLine}${meaningLine}
              <div class="text-sm mt-4 text-gray-200 italic">Vuốt phải để đánh dấu đã thuộc, vuốt trái nếu chưa thuộc</div>`;
          }, { once: true });
        }

        addSwipeHandler(cardEl, () => {
          if (!completed.has(w.traditional)) {
            completed.add(w.traditional);
          }
          i++;
          render();
        }, () => {
          // Vuốt trái: chưa thuộc => đẩy về cuối, không tăng count
          if (!words.slice(i + 1).some(x => x.traditional === w.traditional)) {
            words.push(w);
          }
          i++;
          render();
        });
      }
      render();
    }

    function toggle(i) {
      if (selected.has(i)) selected.delete(i); else selected.add(i);
      renderReviewMenu();
    }

    function startReview() {
      let words = [];
      selected.forEach(b => { words = words.concat(progress[b] || []); });
      if (!words.length) return alert("Chưa có từ để ôn tập!");
      words = words.sort(() => Math.random() - 0.5);
      renderFlashcards(words, "review");
    }

    function renderReviewMenu() {
      app.innerHTML = `
        <h2 class="text-2xl font-bold text-center mb-4">Chọn buổi ôn tập</h2>
        <div class="space-y-3">
          ${sessions.map((s, i) => {
            const isSel = selected.has(i + 1);
            return `<button onclick="toggle(${i + 1})" class="w-full p-4 rounded-lg shadow ${isSel ? 'bg-blue-800' : 'bg-gray-800'} text-white">
              Buổi ${i + 1} (${(progress[i + 1] || []).length}/${s.length} từ)
            </button>`;
          }).join("")}
        </div>
        <button onclick="startReview()" class="fixed bottom-20 right-4 bg-gray-500 text-white px-4 py-2 rounded shadow hover:bg-gray-600">
          Bắt đầu ôn tập
        </button>`;
    }

    function renderLearnMenu() {
      app.innerHTML = `
        <h2 class="text-2xl font-bold text-center mb-4">Chọn buổi học</h2>
        <div class="space-y-3">
          ${sessions.map((s, i) => {
            const done = (progress[i + 1] || []).length === s.length;
            return `<button onclick="renderFlashcards(sessions[${i}], 'learn', ${i})" class="w-full p-4 rounded-lg shadow ${done ? 'bg-green-700' : 'bg-gray-800'} text-white">
              Buổi ${i + 1} - ${(progress[i + 1] || []).length}/${s.length} từ đã thuộc
            </button>`;
          }).join("")}
        </div>`;
    }

    function renderHome() {
      app.innerHTML = `
        <h1 class="text-2xl font-bold text-center mb-6">Flashcard Tiếng Trung</h1>
        <div class="space-y-4">
          <button onclick="renderLearnMenu()" class="w-full bg-green-700 text-white px-4 py-3 rounded-lg shadow hover:bg-green-800">
            Học từ theo buổi
          </button>
          <button onclick="renderReviewMenu()" class="w-full bg-blue-700 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-800">
            Ôn lại bằng flashcard
          </button>
        </div>`;
    }

    fetch("data.json")
      .then(r => r.json())
      .then(data => {
        fullData = data.map(item => {
          const hanzi = Object.keys(item)[0];
          return {
            traditional: item["啊"] || hanzi,
            pinyin: item["ā"] || "",
            meaning: item["a, à, á"] || ""
          };
        });
        const sessionSize = 10;
        for (let i = 0; i < Math.ceil(fullData.length / sessionSize); i++) {
          const start = i * sessionSize;
          const chunk = fullData.slice(start, start + sessionSize);
          if (chunk.length > 0) sessions.push(chunk);
        }
        progress = local.load("progress") || {};
        renderHome();
      });
  </script></body></html>
